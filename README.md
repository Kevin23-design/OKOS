# lab2
## 过程日志
1. 2025.9.29 更新lab2文件
2. 2025.9.29 张子扬完成修改pmem.c，完成lab2第一阶段
3. 202510.13 王俊翔完成lab2第二阶段

## 实验分析
该实验的主题是内存管理初步，目标是为了实现物理内存管理和内核态虚拟内存管理。
### 第一阶段: 物理内存
该阶段是为了管理由 ALLOC_BEGIN ~ ALLOC_END 区域的物理页的相关内容，该内存布局由 kernel.ld 定义，其示意图如下：
```
物理地址空间划分：
┌────────────────────────────────────┐
│ 0x80000000 ~ KERNEL_DATA           │ ← 内核代码段（不可分配）
├────────────────────────────────────┤
│ KERNEL_DATA ~ ALLOC_BEGIN          │ ← 内核数据段（不可分配）
├────────────────────────────────────┤
│ ALLOC_BEGIN ~ (ALLOC_BEGIN+4MB)    │ ← 内核物理页池（1024页）
├────────────────────────────────────┤
│ (ALLOC_BEGIN+4MB) ~ ALLOC_END      │ ← 用户物理页池（剩余页）
└────────────────────────────────────┘
```

完成 pmem.c 的修改实现以下函数：
```
void pmem_init();    // 初始化系统, 只调用一次
void* pmem_alloc();  // 申请一个空闲的物理页
void pmem_free();    // 释放一个之前申请的物理页
```
#### test1
完成 test1 这个测试用例，它的作用是：
向cpu-0和cpu-1并行申请全部1024个内核页, 赋值并输出信息，待申请全部结束， 并行释放所有申请的物理内存，从而验证自旋锁保护的正确性，验证内存清零和数据写入。实验结果的截图如下：

![alt text](pictures/lab2截图01.png)

#### test2
test2测试用例的作用是：
1. 测试内存耗尽的`panic`是否正常触发
2. 测试用户空间物理页申请和释放的正确性

实验结果的截图如下：
![alt text](pictures/lab2截图02.png)

### 第二阶段: 内核态虚拟内存
修改 kvm.c ，实现页表项(PTE) 和 页表(pgtbl)。
#### test1
test1测试用例测试了两件事情:
1. 使用内核页表后你的OS内核是否还能正常执行
2. 使用映射和解映射操作修改你的页表, 使用vm_print输出它被修改前后的对比

实验结果截图如下：
![alt text](pictures/lab2截图03.png)

#### test2
这个测试用例主要关注映射和解映射是否正确执行，得到的实验结果截图如下：
![alt text](pictures/lab2截图04.png)

## 实验感想
1. 与 CSAPP 的内容有所呼应，CSAPP 中介绍的页表结构、地址翻译机制、内存分配策略等概念在此次实验中得到了具体实现。特别是对虚拟内存"为每个进程提供独立地址空间假象"这一核心思想的理解更加深刻，从理论层面的页表遍历算法到实际的RISC-V SV39规范实现，真正体验了从抽象概念到硬件实现的完整过程，从理论到实践。
